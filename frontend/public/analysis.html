<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analisis TF-IDF - EduTrendID</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="../assets/css/style.css" rel="stylesheet">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html">ðŸŽ“ EduTrendID</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="articles.html">Artikel</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="analysis.html">Analisis</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="sources.html">Sumber Berita</a>
          </li>
        </ul>
        <button class="btn btn-outline-danger" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mt-4">
    <!-- Page Header -->
    <div class="page-header text-center mb-4">
      <h1><i class="bi bi-bar-chart-line"></i> Analisis TF-IDF</h1>
      <p>Kata-kata penting dalam berita pendidikan Yogyakarta</p>
    </div>

    <!-- Filter Periode -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-md-4">
                <label class="form-label">Periode Analisis</label>
                <select class="form-select" id="filterPeriode">
                  <option value="">Periode Terbaru</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Jumlah Kata</label>
                <select class="form-select" id="filterLimit">
                  <option value="10">Top 10</option>
                  <option value="15">Top 15</option>
                  <option value="20" selected>Top 20</option>
                  <option value="30">Top 30</option>
                </select>
              </div>
              <div class="col-md-3">
                <button class="btn btn-primary w-100" onclick="loadAnalysis()">
                  <i class="bi bi-arrow-clockwise"></i> Refresh Data
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grafik -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-graph-up"></i> Grafik Nilai TF-IDF</h5>
          </div>
          <div class="card-body">
            <canvas id="tfidfChart" style="max-height: 400px;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabel Top Kata -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-list-ol"></i> Top Kata TF-IDF</h5>
            <span class="badge bg-primary" id="totalBadge">0 kata</span>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th style="width: 10%;">Peringkat</th>
                    <th style="width: 30%;">Kata</th>
                    <th style="width: 30%;">Nilai TF-IDF</th>
                    <th style="width: 30%;">Frekuensi</th>
                  </tr>
                </thead>
                <tbody id="tfidfTableBody">
                  <tr>
                    <td colspan="4" class="text-center">Memuat data...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Word Cloud Placeholder -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-cloud"></i> Word Cloud</h5>
          </div>
          <div class="card-body text-center">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i>
              Word Cloud dapat dibuat menggunakan library eksternal seperti 
              <strong>wordcloud2.js</strong> atau tools online, lalu ditampilkan di sini.
              <br>
              Untuk implementasi, kata-kata dari TF-IDF di atas dapat diexport dan 
              divisualisasikan menggunakan Python (matplotlib + wordcloud) atau JavaScript.
            </div>
            <!-- Placeholder untuk word cloud image -->
            <img 
              id="wordcloudImage" 
              src="https://via.placeholder.com/800x400?text=Word+Cloud+Placeholder" 
              alt="Word Cloud" 
              class="img-fluid rounded"
              style="max-width: 100%; height: auto;"
            >
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Utils JS -->
  <script src="../assets/js/utils.js"></script>

  <!-- Analysis Script -->
  <script>
    // Cek autentikasi
    if (!requireAuth()) {
      // Redirect handled by requireAuth
    }

    let chart = null;

    // Load data saat halaman dimuat
    document.addEventListener('DOMContentLoaded', () => {
      loadPeriods();
      loadAnalysis();
    });

    // Fungsi untuk load daftar periode
    async function loadPeriods() {
      try {
        const response = await fetchWithAuth(`${API_BASE_URL}/analysis/periods`);
        const result = await response.json();

        if (result.success && result.data.length > 0) {
          const select = document.getElementById('filterPeriode');
          
          result.data.forEach(periode => {
            const option = document.createElement('option');
            option.value = periode;
            option.textContent = periode;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading periods:', error);
      }
    }

    // Fungsi untuk load analisis TF-IDF
    async function loadAnalysis() {
      const periode = document.getElementById('filterPeriode').value;
      const limit = document.getElementById('filterLimit').value;

      const params = new URLSearchParams({
        limit: limit,
        periode: periode
      });

      try {
        const response = await fetchWithAuth(`${API_BASE_URL}/analysis/tfidf-top?${params}`);
        const result = await response.json();

        if (result.success && result.data.length > 0) {
          // Update badge
          document.getElementById('totalBadge').textContent = `${result.data.length} kata`;

          // Render tabel
          renderTable(result.data);

          // Render chart
          renderChart(result.data);
        } else {
          document.getElementById('tfidfTableBody').innerHTML = 
            '<tr><td colspan="4" class="text-center">Belum ada data analisis. Jalankan analisis TF-IDF di Dashboard.</td></tr>';
          
          if (chart) {
            chart.destroy();
            chart = null;
          }
        }
      } catch (error) {
        console.error('Error loading analysis:', error);
        document.getElementById('tfidfTableBody').innerHTML = 
          '<tr><td colspan="4" class="text-center text-danger">Gagal memuat data</td></tr>';
      }
    }

    // Fungsi untuk render tabel
    function renderTable(data) {
      const tbody = document.getElementById('tfidfTableBody');
      
      tbody.innerHTML = data.map((item, index) => {
        return `
          <tr>
            <td><strong>#${index + 1}</strong></td>
            <td><span class="badge bg-primary">${item.kata}</span></td>
            <td>
              <div class="progress" style="height: 25px;">
                <div 
                  class="progress-bar" 
                  role="progressbar" 
                  style="width: ${(item.nilai_tfidf / data[0].nilai_tfidf) * 100}%"
                  aria-valuenow="${item.nilai_tfidf}" 
                  aria-valuemin="0" 
                  aria-valuemax="${data[0].nilai_tfidf}"
                >
                  ${item.nilai_tfidf.toFixed(4)}
                </div>
              </div>
            </td>
            <td>${formatNumber(item.frekuensi)} kali</td>
          </tr>
        `;
      }).join('');
    }

    // Fungsi untuk render chart
    function renderChart(data) {
      const ctx = document.getElementById('tfidfChart').getContext('2d');

      // Destroy chart lama jika ada
      if (chart) {
        chart.destroy();
      }

      // Buat chart baru
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(item => item.kata),
          datasets: [{
            label: 'Nilai TF-IDF',
            data: data.map(item => item.nilai_tfidf),
            backgroundColor: 'rgba(37, 99, 235, 0.7)',
            borderColor: 'rgba(37, 99, 235, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Distribusi Nilai TF-IDF Top Kata',
              font: {
                size: 16,
                weight: 'bold'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `TF-IDF: ${context.parsed.y.toFixed(4)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Nilai TF-IDF'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Kata Kunci'
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
