<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - EduTrendID</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="../assets/css/style.css" rel="stylesheet">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html">üéì EduTrendID</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="dashboard.html">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="articles.html">Artikel</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="analysis.html">Analisis</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="sources.html">Sumber Berita</a>
          </li>
        </ul>
        <button class="btn btn-outline-danger" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mt-4">
    <!-- Page Header -->
    <div class="page-header text-center mb-4">
      <h1><i class="bi bi-speedometer2"></i> Dashboard Admin</h1>
      <p>Kelola dan analisis berita pendidikan Yogyakarta</p>
    </div>

    <!-- Statistik Cards -->
    <div class="row g-4 mb-4">
      <div class="col-md-4">
        <div class="card">
          <div class="card-body stat-card">
            <h2 id="totalArtikel">-</h2>
            <p>Total Artikel</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body stat-card">
            <h2 id="totalSumber">-</h2>
            <p>Sumber Berita</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body stat-card">
            <h2 id="scrapingTerakhir">-</h2>
            <p>Scraping Terakhir</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Aksi Cepat</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <button class="btn btn-primary w-100" onclick="scrapeNow()">
                  <i class="bi bi-cloud-download"></i> Scrape Sekarang
                </button>
              </div>
              <div class="col-md-4">
                <button class="btn btn-success w-100" onclick="preprocessNow()">
                  <i class="bi bi-tools"></i> Preprocess Data
                </button>
              </div>
              <div class="col-md-4">
                <button class="btn btn-warning w-100" onclick="analyzeNow()">
                  <i class="bi bi-graph-up"></i> Analisis TF-IDF
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Log Proses Terbaru -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Log Proses Terbaru</h5>
            <button class="btn btn-sm btn-outline-primary" onclick="loadLogs()">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Waktu</th>
                    <th>Jenis Proses</th>
                    <th>Status</th>
                    <th>Keterangan</th>
                  </tr>
                </thead>
                <tbody id="logTableBody">
                  <tr>
                    <td colspan="4" class="text-center">Memuat data...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Utils JS -->
  <script src="../assets/js/utils.js"></script>

  <!-- Dashboard Script -->
  <script>
    // Cek autentikasi saat halaman dimuat
    if (!requireAuth()) {
      // Jika tidak login, akan redirect ke login (handled di utils.js)
    }

    // Load data saat halaman dimuat
    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadLogs();
    });

    // Fungsi untuk load statistik
    async function loadStats() {
      try {
        const response = await fetchWithAuth(`${API_BASE_URL}/articles/stats`);
        const result = await response.json();

        if (result.success) {
          document.getElementById('totalArtikel').textContent = formatNumber(result.data.totalArtikel);
          document.getElementById('totalSumber').textContent = formatNumber(result.data.totalSumber);
          
          // Format tanggal scraping terakhir
          if (result.data.scrapingTerakhir) {
            const date = new Date(result.data.scrapingTerakhir);
            document.getElementById('scrapingTerakhir').textContent = date.toLocaleDateString('id-ID', { month: 'short', day: 'numeric' });
          } else {
            document.getElementById('scrapingTerakhir').textContent = 'Belum Ada';
          }
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Fungsi untuk load log proses
    async function loadLogs() {
      try {
        const response = await fetchWithAuth(`${API_BASE_URL}/processing/logs/latest?limit=10`);
        const result = await response.json();

        const tbody = document.getElementById('logTableBody');

        if (result.success && result.data.length > 0) {
          tbody.innerHTML = result.data.map(log => {
            const statusBadge = log.status === 'berhasil' 
              ? '<span class="badge bg-success">Berhasil</span>'
              : '<span class="badge bg-danger">Gagal</span>';
            
            const jenisLabel = {
              'scrape': '<span class="badge bg-primary">Scraping</span>',
              'preprocess': '<span class="badge bg-info">Preprocessing</span>',
              'analyze': '<span class="badge bg-warning">Analisis</span>'
            }[log.jenis_proses] || log.jenis_proses;

            return `
              <tr>
                <td>${formatDate(log.waktu)}</td>
                <td>${jenisLabel}</td>
                <td>${statusBadge}</td>
                <td>${log.keterangan || '-'}</td>
              </tr>
            `;
          }).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada log proses</td></tr>';
        }
      } catch (error) {
        console.error('Error loading logs:', error);
        document.getElementById('logTableBody').innerHTML = 
          '<tr><td colspan="4" class="text-center text-danger">Gagal memuat log</td></tr>';
      }
    }

    // Fungsi untuk scraping
    async function scrapeNow() {
      const btn = event.target;
      
      if (!confirm('Mulai scraping berita sekarang?')) return;

      setButtonLoading(btn, true);

      try {
        const response = await fetchWithAuth(`${API_BASE_URL}/processing/scrape`, {
          method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
          showAlert(`‚úÖ Scraping selesai! ${result.data.totalBaru} artikel baru ditambahkan.`, 'success');
          loadStats();
          loadLogs();
        } else {
          showAlert(`‚ùå ${result.message}`, 'danger');
        }
      } catch (error) {
        console.error('Error scraping:', error);
        showAlert('‚ùå Terjadi kesalahan saat scraping', 'danger');
      } finally {
        setButtonLoading(btn, false);
      }
    }

    // Fungsi untuk preprocessing
    async function preprocessNow() {
      const btn = event.target;
      
      if (!confirm('Mulai preprocessing artikel sekarang?')) return;

      setButtonLoading(btn, true);

      try {
        const response = await fetchWithAuth(`${API_BASE_URL}/processing/preprocess`, {
          method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
          showAlert(`‚úÖ Preprocessing selesai! ${result.data.totalProcessed} artikel diproses.`, 'success');
          loadLogs();
        } else {
          showAlert(`‚ùå ${result.message}`, 'danger');
        }
      } catch (error) {
        console.error('Error preprocessing:', error);
        showAlert('‚ùå Terjadi kesalahan saat preprocessing', 'danger');
      } finally {
        setButtonLoading(btn, false);
      }
    }

    // Fungsi untuk analisis TF-IDF
    async function analyzeNow() {
      const btn = event.target;
      
      if (!confirm('Mulai analisis TF-IDF sekarang?')) return;

      setButtonLoading(btn, true);

      try {
        const response = await fetchWithAuth(`${API_BASE_URL}/analysis/analyze`, {
          method: 'POST',
          body: JSON.stringify({ topN: 20 })
        });

        const result = await response.json();

        if (result.success) {
          showAlert(`‚úÖ Analisis selesai! Top ${result.data.topN} kata telah disimpan.`, 'success');
          loadLogs();
        } else {
          showAlert(`‚ùå ${result.message}`, 'danger');
        }
      } catch (error) {
        console.error('Error analyzing:', error);
        showAlert('‚ùå Terjadi kesalahan saat analisis', 'danger');
      } finally {
        setButtonLoading(btn, false);
      }
    }
  </script>
</body>
</html>
